files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_validate_environment.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      echo "Validating critical environment variables..."

      # Check for DATABASE_URL
      if [ -z "$DATABASE_URL" ]; then
        echo "ERROR: DATABASE_URL environment variable is not set!"
        echo "This is required for PostgreSQL database connection."
        echo "Set it in EB environment configuration."
        exit 1
      fi

      # Check for SESSION_SECRET
      if [ -z "$SESSION_SECRET" ]; then
        echo "ERROR: SESSION_SECRET environment variable is not set!"
        echo "This is required for secure session encryption."
        echo "Generate a secure random string (32+ characters) and set it in EB environment configuration."
        exit 1
      fi

      # Check for WS_ALLOWED_ORIGINS
      if [ -z "$WS_ALLOWED_ORIGINS" ]; then
        echo "WARNING: WS_ALLOWED_ORIGINS environment variable is not set!"
        echo "WebSocket connections may fail due to CORS restrictions."
        echo "Set this to your domain(s) or '*' for development."
      fi

      echo "Environment validation completed successfully."

  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_check_build_artifacts.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      echo "Checking build artifacts..."

      # Check if dist directory exists
      if [ ! -d "/var/app/ondeck/dist" ]; then
        echo "ERROR: dist directory not found!"
        echo "Make sure 'npm run build' was executed before creating deployment bundle."
        exit 1
      fi

      # Check if backend build exists
      if [ ! -f "/var/app/ondeck/dist/index.js" ]; then
        echo "ERROR: Backend build artifact (dist/index.js) not found!"
        echo "Backend build may have failed."
        exit 1
      fi

      # Check if frontend build exists
      if [ ! -d "/var/app/ondeck/dist/public" ]; then
        echo "ERROR: Frontend build directory (dist/public) not found!"
        echo "Frontend build may have failed."
        exit 1
      fi

      if [ ! -f "/var/app/ondeck/dist/public/index.html" ]; then
        echo "ERROR: Frontend index.html not found in dist/public!"
        echo "Frontend build may have failed."
        exit 1
      fi

      echo "Build artifacts validation completed successfully."

container_commands:
  01_set_permissions:
    command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/pre/*.sh"